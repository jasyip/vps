(global) {
  servers {
    metrics
  }

  crowdsec {
    api_url http://crowdsec:8080
    api_key `{$CROWDSEC_BOUNCER_API_KEY}`
    ticker_interval 15s
    # disable_streaming
    # enable_hard_fails
  }
}


(servers) {

  :2019 {
    @metrics {
      remote_ip private_ranges
      path /metrics
    }

    handle @metrics {
      metrics
    }
    handle {
      abort
    }
  }

  `www.{args[0]}` {
    redir https://{args[0]}{uri} permanent
  }

  {args[0]} {
    log {
      output file /var/log/caddy/access.log
    }

    route {
      crowdsec
      file_server
    }
  }

  `{$GRAFANA_SUBDOMAIN}.{args[0]}` {
    reverse_proxy http://grafana:3000
  }
}



(development) {
  {
    import global
    debug
  }

  import servers localhost
}

(production) {
  {
    import global

    email `{$EMAIL}`

    servers `{$DOMAIN}:443` {
      name public
    }
  }

  import servers `{$DOMAIN}`
}

{$CADDY_EXTRA_DIRECTIVES}

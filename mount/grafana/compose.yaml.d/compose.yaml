services:
  grafana:
    extends:
      file: ${MODE}.yaml
      service: grafana
    build:
      context: ..
      args:
        GRAFANA_VERSION: "$VERSION_GRAFANA"
      tags:
        - "${COMPOSE_PROJECT_NAME}/grafana:${VERSION_GRAFANA}"
    secrets:
      - source: grafana_postgresql_password
        target: postgresql_password
    environment:
      MODE: "$MODE"
    volumes:
      - grafana_data:/var/lib/grafana
      - grafana_logs:/var/log/grafana
      - type: bind
        source: /run/postgresql
        target: /run/postgresql
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

secrets:
  grafana_postgresql_password:
    file: ./grafana/compose.yaml.d/secrets/${MODE}/postgresql_password

volumes:
  grafana_data:
    name: ${COMPOSE_PROJECT_NAME}.${MODE}.grafana.data
  grafana_logs:
    name: ${COMPOSE_PROJECT_NAME}.${MODE}.grafana.logs
